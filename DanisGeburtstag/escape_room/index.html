<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Die Verbotene Abteilung</title>

    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="../minigames.css">
</head>

<body>

    <!-- 3D Canvas -->
    <canvas id="game-canvas"></canvas>

    <!-- HUD -->
    <div class="crosshair" id="crosshair"></div>

    <div id="interactionPrompt" class="interaction-prompt"></div>

    <div class="stamina-bar" id="staminaBar">
        <div class="stamina-fill" id="staminaFill" style="width: 100%;"></div>
    </div>

    <div class="game-hud">
        <div class="progress-tracker">
            <div class="progress-gem" data-game="1" title="Vielsaft-Trank"></div>
            <div class="progress-gem" data-game="2" title="FlÃ¼sternde BÃ¼cher"></div>
            <div class="progress-gem" data-game="3" title="Die Chiffre"></div>
            <div class="progress-gem" data-game="4" title="Bewegende Treppen"></div>
            <div class="progress-gem" data-game="5" title="Geheime Tinte"></div>
            <div class="progress-gem" data-game="6" title="Die Glocken"></div>
            <div class="progress-gem" data-game="7" title="Die Chronik"></div>
        </div>
    </div>

    <!-- Settings -->
    <button class="settings-btn" onclick="toggleSettings()">âš™</button>
    <div class="settings-panel" id="settingsPanel">
        <h3>Einstellungen</h3>
        <div class="setting-row">
            <label>Gehgeschwindigkeit</label>
            <input type="range" id="walkSpeedSlider" min="1.5" max="5" step="0.5" value="3">
        </div>
        <div class="setting-row">
            <label>Mausempfindlichkeit</label>
            <input type="range" id="sensitivitySlider" min="0.3" max="2" step="0.1" value="1">
        </div>
        <div class="setting-row">
            <label>Helligkeit</label>
            <input type="range" id="bloomSlider" min="0.5" max="1.5" step="0.1" value="1">
        </div>
        <div class="setting-row">
            <label>Nebelweite</label>
            <input type="range" id="fogSlider" min="10" max="30" step="2" value="22">
        </div>
    </div>

    <!-- Book Popup -->
    <div class="book-popup" id="bookPopup">
        <h3 id="bookTitle"></h3>
        <p id="bookContent"></p>
    </div>

    <!-- Controls Hint -->
    <div class="controls-hint">
        <p><kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> Bewegen</p>
        <p><kbd>Shift</kbd> Rennen</p>
        <p><kbd>E</kbd> Interagieren</p>
        <p><kbd>ESC</kbd> MenÃ¼ schlieÃŸen</p>
    </div>

    <!-- Intro Overlay -->
    <div class="intro-overlay" id="introOverlay">
        <h1 class="intro-title">Die Verbotene Abteilung</h1>
        <p class="intro-subtitle">Ein magisches Escape Room Abenteuer</p>
        <button class="start-btn" onclick="startGame()">Betreten</button>
    </div>

    <!-- ============================================================================
     MINIGAME MODALS
     ============================================================================ -->

    <!-- Minigame 1: Polyjuice Potion -->
    <div class="minigame-modal" id="minigame1">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ§ª Der Vielsaft-Trank</h2>
                <div class="modal-controls">
                    <button class="btn btn-hint" onclick="showHint(1)">ğŸ’¡</button>
                    <button class="btn btn-reset" onclick="polyjuiceGame.reset()">ğŸ”„</button>
                    <button class="btn btn-close" onclick="closeMinigame(1)">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: #d4c4a8; font-style: italic; margin-bottom: 20px;">
                    â€Jede Zutat in den richtigen Kessel..."
                </p>
                <div
                    style="background: rgba(0,0,0,0.3); border: 1px solid #8b7355; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="color: #a89888; font-size: 13px; text-align: center; margin-bottom: 10px;">ğŸ“œ Aus dem
                        verbotenen Rezept:</p>
                    <div
                        style="color: #c9b896; font-size: 13px; font-style: italic; line-height: 1.8; text-align: center;">
                        <p>â€Das Kraut des Flusses scheut die rÃ¶tliche Schale,</p>
                        <p>doch im grauen Metall findet es keinen Frieden.â€œ</p>

                        <p style="margin-top: 8px;">â€Der Sauger des Blutes verlangt nach StÃ¤rke,</p>
                        <p>nicht nach dem weichen Glanz.â€œ</p>

                        <p style="margin-top: 8px;">â€Der gefleckte Falter tanzt nur dort,</p>
                        <p>wo das Feuer am hÃ¶chsten lodert.â€œ</p>

                        <p style="margin-top: 8px;">â€Was bleibt, flieÃŸt nicht zum Eisen,</p>
                        <p>sondern ruht im letzten der Metalle.â€œ</p>
                    </div>

                </div>
                <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 30px;">
                    <div style="text-align: center;">
                        <div class="cauldron" data-cauldron="copper"
                            style="width: 100px; height: 120px; background: linear-gradient(135deg, #b87333, #8b5a2b); border-radius: 10px 10px 50px 50px; display: flex; align-items: center; justify-content: center; font-size: 30px; border: 3px solid #cd7f32; box-shadow: inset 0 -20px 30px rgba(0,0,0,0.3);">
                        </div>
                        <p style="margin-top: 8px; color: #cd7f32;">Kupfer</p>
                    </div>
                    <div style="text-align: center;">
                        <div class="cauldron" data-cauldron="iron"
                            style="width: 100px; height: 120px; background: linear-gradient(135deg, #5a5a5a, #3a3a3a); border-radius: 10px 10px 50px 50px; display: flex; align-items: center; justify-content: center; font-size: 30px; border: 3px solid #6a6a6a; box-shadow: inset 0 -20px 30px rgba(0,0,0,0.3);">
                        </div>
                        <p style="margin-top: 8px; color: #8a8a8a;">Eisen</p>
                    </div>
                    <div style="text-align: center;">
                        <div class="cauldron" data-cauldron="tin"
                            style="width: 100px; height: 120px; background: linear-gradient(135deg, #8a8a8a, #6a6a6a); border-radius: 10px 10px 50px 50px; display: flex; align-items: center; justify-content: center; font-size: 30px; border: 3px solid #9a9a9a; box-shadow: inset 0 -20px 30px rgba(0,0,0,0.3);">
                        </div>
                        <p style="margin-top: 8px; color: #aaaaaa;">Zinn</p>
                    </div>
                    <div style="text-align: center;">
                        <div class="cauldron" data-cauldron="stone"
                            style="width: 100px; height: 120px; background: linear-gradient(135deg, #6a5a4a, #4a3a2a); border-radius: 10px 10px 50px 50px; display: flex; align-items: center; justify-content: center; font-size: 30px; border: 3px solid #7a6a5a; box-shadow: inset 0 -20px 30px rgba(0,0,0,0.3);">
                        </div>
                        <p style="margin-top: 8px; color: #9a8a7a;">Stein</p>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                    <div class="ingredient" draggable="true" data-ingredient="fluxweed"
                        style="padding: 15px 20px; background: linear-gradient(135deg, #2d5a27, #1a3a17); border: 2px solid #4a8a44; border-radius: 10px; cursor: grab; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <span style="font-size: 30px;">ğŸŒ¿</span><span
                            style="color: #8fbc8f; font-size: 12px;">Fluxkraut</span></div>
                    <div class="ingredient" draggable="true" data-ingredient="knotgrass"
                        style="padding: 15px 20px; background: linear-gradient(135deg, #3a5a2a, #2a4a1a); border: 2px solid #5a8a4a; border-radius: 10px; cursor: grab; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <span style="font-size: 30px;">ğŸŒ¾</span><span
                            style="color: #9acd32; font-size: 12px;">KnÃ¶terich</span></div>
                    <div class="ingredient" draggable="true" data-ingredient="lacewing"
                        style="padding: 15px 20px; background: linear-gradient(135deg, #4a3a5a, #3a2a4a); border: 2px solid #6a5a7a; border-radius: 10px; cursor: grab; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <span style="font-size: 30px;">ğŸ¦‹</span><span
                            style="color: #dda0dd; font-size: 12px;">Florfliegen</span></div>
                    <div class="ingredient" draggable="true" data-ingredient="leech"
                        style="padding: 15px 20px; background: linear-gradient(135deg, #4a2a2a, #3a1a1a); border: 2px solid #6a3a3a; border-radius: 10px; cursor: grab; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <span style="font-size: 30px;">ğŸ©¸</span><span
                            style="color: #cd5c5c; font-size: 12px;">Blutegel</span></div>
                </div>
                <button onclick="polyjuiceGame.check()"
                    style="display: block; margin: 25px auto 0; padding: 12px 30px; font-size: 16px; background: linear-gradient(135deg, #8b4513, #654321); color: #f5e6d3; border: 2px solid #a0522d; border-radius: 10px; cursor: pointer;">ğŸ”¥
                    Brauen</button>
            </div>
        </div>
    </div>

    <!-- Minigame 2: Key Catch (Fliegende SchlÃ¼ssel) -->
    <div class="minigame-modal" id="minigame2">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ”‘ Fliegende SchlÃ¼ssel</h2>
                <div class="modal-controls">
                    <button class="btn btn-hint" onclick="showHint(2)">ğŸ’¡</button>
                    <button class="btn btn-reset" onclick="keyCatch.reset()">ğŸ”„</button>
                    <button class="btn btn-close" onclick="closeMinigame(2)">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: #d4c4a8; font-style: italic; margin-bottom: 15px;">â€Nur einer
                    Ã¶ffnet die TÃ¼r zur Wahrheit...â€œ</p>
                <div id="keyContainer"></div>
            </div>
        </div>
    </div>

    <!-- Minigame 3: Cipher -->
    <div class="minigame-modal" id="minigame3">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ” Die Chiffre</h2>
                <div class="modal-controls">
                    <button class="btn btn-hint" onclick="showHint(3)">ğŸ’¡</button>
                    <button class="btn btn-reset" onclick="initCipher()">ğŸ”„</button>
                    <button class="btn btn-close" onclick="closeMinigame(3)">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <div id="cipherContainer"></div>
            </div>
        </div>
    </div>

    <!-- Minigame 4: Staircase -->
    <div class="minigame-modal" id="minigame4">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸªœ Die Treppen</h2>
                <div class="modal-controls">
                    <button class="btn btn-hint" onclick="showHint(4)">ğŸ’¡</button>
                    <button class="btn btn-reset" onclick="initStaircase()">ğŸ”„</button>
                    <button class="btn btn-close" onclick="closeMinigame(4)">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <div id="staircaseContainer"></div>
            </div>
        </div>
    </div>

    <!-- Minigame 5: Invisible Ink -->
    <div class="minigame-modal" id="minigame5">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ•¯ï¸ Geheime Tinte</h2>
                <div class="modal-controls">
                    <button class="btn btn-hint" onclick="showHint(5)">ğŸ’¡</button>
                    <button class="btn btn-reset" onclick="initInvisibleInk()">ğŸ”„</button>
                    <button class="btn btn-close" onclick="closeMinigame(5)">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: #d4c4a8; font-style: italic; margin-bottom: 15px;">â€WÃ¤rme offenbart
                    die Wahrheit..."</p>
                <canvas id="parchmentCanvas" width="400" height="400"></canvas>
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <input type="text" id="inkGuessInput" placeholder="Was siehst du?"
                        style="padding: 10px 15px; font-size: 16px; border: 2px solid #8b7355; border-radius: 8px; background: #f5e6d3; color: #4a3520; width: 200px;"
                        onkeypress="if(event.key === 'Enter') checkInvisibleInkGuess(this.value);">
                    <button onclick="checkInvisibleInkGuess(document.getElementById('inkGuessInput').value)"
                        style="padding: 10px 20px; font-size: 16px; background: linear-gradient(135deg, #8b4513, #654321); color: #f5e6d3; border: none; border-radius: 8px; cursor: pointer;">âœ¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Minigame 6: Bells -->
    <div class="minigame-modal" id="minigame6">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ”” Die Glocken</h2>
                <div class="modal-controls">
                    <button class="btn btn-hint" onclick="showHint(6)">ğŸ’¡</button>
                    <button class="btn btn-reset" onclick="resetBellGame()">ğŸ”„</button>
                    <button class="btn btn-close" onclick="closeMinigame(6)">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: #d4c4a8; font-style: italic; margin-bottom: 15px;">â€Zeit flieÃŸt
                    auch rÃ¼ckwÃ¤rts..."</p>
                <div id="bellPhase" style="text-align: center; font-size: 14px; margin-bottom: 10px; color: #d4c4a8;">
                </div>
                <div id="bellContainer"></div>
            </div>
        </div>
    </div>

    <!-- Minigame 7: sort Books -->
    <div class="minigame-modal" id="minigame7">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“– Die FlÃ¼sternden BuchrÃ¼cken</h2>
                <div class="modal-controls">
                    <button class="btn btn-hint" onclick="showHint(7)">ğŸ’¡</button>
                    <button class="btn btn-reset"
                        onclick="if(typeof sortBooks !== 'undefined') sortBooks.reset()">ğŸ”„</button>
                    <button class="btn btn-close" onclick="closeMinigame(7)">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <div id="sortBooksContainer"></div>
            </div>
        </div>
    </div>

    <!-- Minigame 8: Pensieve -->
    <div class="minigame-modal" id="minigame8">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸŒ€ Das Denkarium</h2>
                <div class="modal-controls">
                    <button class="btn btn-hint" onclick="showHint(8)">ğŸ’¡</button>
                    <button class="btn btn-close" onclick="closeMinigame(8)">âœ•</button>
                </div>
            </div>
            <div class="modal-body">
                <div style="text-align: center;">
                    <svg width="200" height="100" viewBox="0 0 200 100">
                        <ellipse cx="100" cy="50" rx="90" ry="40" fill="rgba(100, 130, 180, 0.2)" stroke="#8b7355"
                            stroke-width="3" />
                    </svg>
                </div>
                <div id="penseiveSlots"></div>
                <div id="availableArtifacts"></div>
            </div>
        </div>
    </div>

    <!-- Marauder's Map Modal -->
    <div class="minigame-modal" id="maraudersMapModal" style="display: none; background: transparent; box-shadow: none;">
        <div class="modal-content marauders-parchment-holder" style="max-width: 800px; background: transparent; border: none; box-shadow: none; padding: 0; position: relative;">
            <div class="modal-header">
                <h2 class="modal-title" style="font-family: 'Palatino', serif; letter-spacing: 2px;">ğŸ—ºï¸ Die Karte des
                    Rumtreibers</h2>
                <div class="modal-controls">
                    <button class="btn btn-close" onclick="closeMaraudersMap()">âœ•</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="parchment-holder-wood">
                  <div class="parchment-holder-shadow"></div>
                  <div id="mapContainer" class="parchment-on-wood">
                    <!-- Parchment texture overlay -->
                    <div class="parchment-texture-overlay"></div>

                    <!-- Map image -->
                    <img src="karte.png" alt="Karte" id="mapImage" class="map-image">

                    <!-- LOCKED MESSAGE (before all puzzles solved) -->
                    <div id="mapLockedMessage" style="
                    position: absolute;
                    top: 0; left: 0; right: 0; bottom: 0;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    background: rgba(20, 15, 10, 0.85);
                    z-index: 20;
                    text-align: center;
                    padding: 40px;
                ">
                        <div style="
                        font-family: 'Palatino', 'Times New Roman', serif;
                        color: #8b7355;
                        font-size: 18px;
                        font-style: italic;
                        line-height: 1.8;
                        max-width: 400px;
                    ">
                            <p style="margin: 0 0 20px 0; font-size: 24px;">â€Mr. Moony grÃ¼ÃŸt den Besucher..."</p>
                            <p style="margin: 0 0 15px 0;">Diese Karte offenbart ihre Geheimnisse nur jenen, die alle
                                PrÃ¼fungen bestanden haben.</p>
                            <p style="margin: 0 0 25px 0; color: #c9a227;">LÃ¶se alle RÃ¤tsel, um den Spruch zu finden.
                            </p>
                            <p id="puzzleCounter" style="
                            margin: 0;
                            font-size: 16px;
                            color: #6a5a4a;
                            font-style: normal;
                        ">0/7 RÃ¤tsel gelÃ¶st</p>
                        </div>
                    </div>

                    <!-- UNLOCK SPELL (shown when all puzzles solved, then fades) -->
                    <div id="mapUnlockSpell" style="
                    position: absolute;
                    top: 0; left: 0; right: 0; bottom: 0;
                    display: none;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    background: rgba(20, 15, 10, 0.9);
                    z-index: 25;
                    text-align: center;
                    padding: 40px;
                    opacity: 0;
                    transition: opacity 1s ease;
                ">
                        <div style="
                        font-family: 'Palatino', 'Times New Roman', serif;
                        color: #c9a227;
                        font-size: 28px;
                        font-style: italic;
                        line-height: 1.6;
                        text-shadow: 0 0 20px rgba(201, 162, 39, 0.5);
                    ">
                            <p style="margin: 0 0 20px 0; font-size: 20px; color: #8b7355;">âœ¨ Alle RÃ¤tsel gelÃ¶st! âœ¨</p>
                            <p style="margin: 0;">â€Ich schwÃ¶re feierlich,</p>
                            <p style="margin: 0;">dass ich ein Tunichtgut bin."</p>
                        </div>
                    </div>

                    <!-- Footsteps container -->
                    <div id="footstepsContainer" style="
                    position: absolute;
                    top: 0; left: 0; right: 0; bottom: 0;
                    pointer-events: none;
                    z-index: 10;
                "></div>

                    <!-- Name label that follows footsteps -->
                    <div id="footstepsLabel" style="
                    position: absolute;
                    font-family: 'Palatino', serif;
                    font-size: 11px;
                    color: #2a1a0a;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    white-space: nowrap;
                    opacity: 0;
                    z-index: 11;
                    transition: opacity 0.3s;
                ">Dani</div>
                                    </div>
                                </div>

                <!-- Map title text -->
                <div style="
                text-align: center;
                padding: 15px;
                font-family: 'Palatino', serif;
                color: #d4c4a8;
                font-style: italic;
            ">
                    <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.7;">Unheil angerichtet!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================================
     SCRIPTS
     ============================================================================ -->

    <!-- THREE.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- MINIGAME SCRIPTS (relative to parent folder) -->
    <script src="../games/minigames-core.js"></script>
    <script src="../games/game1-polyjuice.js"></script>
    <script src="../games/game3-cipher.js"></script>
    <script src="../games/game4-staircase.js"></script>
    <script src="../games/game5-invisibleink.js"></script>
    <script src="../games/game6-bells.js"></script>
    <script src="../games/game7-keycatch.js"></script>
    <script src="../games/game2-booksort.js"></script>
    <script src="../games/game8-pensieve.js"></script>

    <!-- ESCAPE ROOM SCRIPTS -->
    <script src="js/config.js"></script>
    <script src="js/room.js"></script>
    <script src="js/furniture.js"></script>
    <script src="js/particles.js"></script>
    <script src="js/controls.js"></script>
    <script src="js/maraudersmap.js"></script>
    <script src="js/main.js"></script>

</body>

</html>